name: Test Coverage

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/test-coverage.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'backend/**'
      - '.github/workflows/test-coverage.yml'

jobs:
  test:
    name: Run Tests with Coverage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.25'
        cache-dependency-path: backend/go.sum

    - name: Install dependencies
      working-directory: ./backend
      run: go mod download

    - name: Run tests with coverage
      working-directory: ./backend
      run: |
        # Find packages with test files
        PACKAGES=$(go list ./internal/... | while read pkg; do
          if go list -f '{{.TestGoFiles}}' $pkg | grep -q '.go'; then
            echo $pkg
          fi
        done | tr '\n' ' ')

        echo "Testing packages: $PACKAGES"

        # Run tests only on packages with test files
        go test -v -coverprofile=coverage.out -covermode=atomic $PACKAGES
        go tool cover -func=coverage.out

    - name: Extract coverage percentage
      id: coverage
      working-directory: ./backend
      run: |
        COVERAGE=$(go tool cover -func=coverage.out | grep total: | awk '{print $3}' | sed 's/%//')
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        echo "Coverage: $COVERAGE%"

    - name: Check coverage threshold
      working-directory: ./backend
      run: |
        COVERAGE=${{ steps.coverage.outputs.coverage }}
        THRESHOLD=70
        echo "Coverage: $COVERAGE%"
        echo "Threshold: $THRESHOLD%"

        if (( $(echo "$COVERAGE < $THRESHOLD" | bc -l) )); then
          echo "❌ Coverage $COVERAGE% is below threshold $THRESHOLD%"
          exit 1
        else
          echo "✅ Coverage $COVERAGE% meets threshold $THRESHOLD%"
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        files: ./backend/coverage.out
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Comment coverage on PR
      if: github.event_name == 'pull_request'
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.coverage.outputs.coverage }}';
          const threshold = 70;
          const passed = parseFloat(coverage) >= threshold;
          const emoji = passed ? '✅' : '❌';

          const body = `## ${emoji} Test Coverage Report

          **Coverage:** ${coverage}%
          **Threshold:** ${threshold}%
          **Status:** ${passed ? 'PASSED' : 'FAILED'}

          ${passed ? 'Great job! Coverage meets the threshold.' : 'Coverage is below the threshold. Please add more tests.'}

          <details>
          <summary>Coverage Details</summary>

          \`\`\`
          Run \`go tool cover -func=coverage.out\` to see detailed coverage by file.
          \`\`\`
          </details>`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });

    - name: Generate coverage badge
      if: github.ref == 'refs/heads/main'
      uses: knightdave/anybadge-action@v1.1.0
      with:
        file: backend/coverage-badge.svg
        label: coverage
        value: ${{ steps.coverage.outputs.coverage }}%
        value-format: "%.1f%%"
        anybadge-args: 50=red 60=orange 70=yellow 80=green

    - name: Verify coverage badge
      if: github.ref == 'refs/heads/main'
      run: |
        if [ -f backend/coverage-badge.svg ]; then
          echo "✅ Coverage badge generated successfully"
          cat backend/coverage-badge.svg
        else
          echo "⚠️ Coverage badge not found"
        fi
