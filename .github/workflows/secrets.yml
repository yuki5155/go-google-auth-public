name: Secrets Stack

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - stg
          - prod

env:
  AWS_REGION: ${{ secrets.AWS_REGION || 'ap-northeast-1' }}
  PROJECT_NAME: ${{ secrets.PROJECT_NAME }}

jobs:
  secrets-stack:
    name: Deploy Secrets Stack
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'iac/package-lock.json'
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ secrets.AWS_REGION || 'ap-northeast-1' }}
          role-session-name: GitHubActions-SecretsDeploy-${{ github.event.inputs.environment }}
    
      - name: Install dependencies
        run: |
          cd iac
          npm install
      
      - name: Check if secret already exists
        id: check-secret
        run: |
          SECRET_NAME="${{ env.PROJECT_NAME }}/${{ github.event.inputs.environment }}/google-auth"
          
          if aws secretsmanager describe-secret --secret-id "$SECRET_NAME" 2>/dev/null; then
            echo "secret-exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Secret already exists: $SECRET_NAME"
          else
            echo "secret-exists=false" >> $GITHUB_OUTPUT
            echo "üìù Secret does not exist, will be created: $SECRET_NAME"
          fi
      
      - name: Deploy Secrets Stack
        if: steps.check-secret.outputs.secret-exists == 'false'
        run: |
          cd iac
          echo "=== Deploying Secrets Stack ==="
          
          ENVIRONMENT=${{ github.event.inputs.environment }}
          CONTEXTS="--context environment=$ENVIRONMENT --context projectName=${{ env.PROJECT_NAME }}"
          
          echo "Environment: $ENVIRONMENT"
          echo "Project Name: ${{ env.PROJECT_NAME }}"
          echo "Secret Name: ${{ env.PROJECT_NAME }}/$ENVIRONMENT/google-auth"
          
          npx cdk deploy --app "npx ts-node --prefer-ts-exts bin/secrets.ts" $CONTEXTS --require-approval never
          
          echo "‚úÖ Secrets Stack deployed successfully"
          echo ""
          echo "‚ö†Ô∏è  IMPORTANT: Update the secret values in AWS Secrets Manager!"
          echo "   Secret Name: ${{ env.PROJECT_NAME }}/$ENVIRONMENT/google-auth"
          echo ""
          echo "   Required keys:"
          echo "   - GOOGLE_CLIENT_ID"
          echo "   - GOOGLE_CLIENT_SECRET"
          echo "   - JWT_SECRET"
      
      - name: Skip deployment (secret exists)
        if: steps.check-secret.outputs.secret-exists == 'true'
        run: |
          echo "‚è≠Ô∏è Skipping deployment - secret already exists"
          echo "Secret Name: ${{ env.PROJECT_NAME }}/${{ github.event.inputs.environment }}/google-auth"
          echo ""
          echo "To update the secret values, use AWS CLI or Console:"
          echo "aws secretsmanager put-secret-value \\"
          echo "  --secret-id \"${{ env.PROJECT_NAME }}/${{ github.event.inputs.environment }}/google-auth\" \\"
          echo "  --secret-string '{\"GOOGLE_CLIENT_ID\":\"...\",\"GOOGLE_CLIENT_SECRET\":\"...\",\"JWT_SECRET\":\"...\"}'"
      
      - name: Deployment Summary
        run: |
          echo "========================================"
          echo "üìã Secrets Stack Deployment Summary"
          echo "========================================"
          echo "Environment: ${{ github.event.inputs.environment }}"
          echo "Project Name: ${{ env.PROJECT_NAME }}"
          echo "Secret Name: ${{ env.PROJECT_NAME }}/${{ github.event.inputs.environment }}/google-auth"
          echo ""
          echo "Next Steps:"
          echo "1. Update secret values in AWS Secrets Manager"
          echo "2. Deploy Backend Stack"
          echo "========================================"
